@model JobSearcher.Account.UserInDatabase?

<div class="modal fade" id="analyzeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg border-0 rounded-4">
            <div class="modal-header border-0 bg-gradient"
                 style="background: linear-gradient(90deg, #4e73df, #1cc88a); color: white;">
                <h5 class="modal-title fw-semibold">Analyze Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <p id="analyzeJobTitle" class="fw-bold mb-2 text-primary"></p>
                </div>

                <div class="mb-3 @(Model?.UserCv != null ? "" : "d-none")">
                    <p class="text-muted">
                        You can use your uploaded CV:
                        <strong>@Model?.UserCv?.Filename</strong> or upload a new one:
                    </p>
                    <input type="file" class="form-control" accept=".pdf,.doc,.docx" />
                </div>

                <div class="similarity-container mt-4">
                    <p class="mb-1 fw-semibold">Fit Score:</p>
                    <div class="progress" style="height: 28px; border-radius: 12px; overflow: hidden;">
                        <div id="similarityBar" class="progress-bar text-center fw-bold"
                             role="progressbar"
                             style="width: 0%; background-color: red; transition: width 0.6s ease, background-color 0.6s ease;"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary px-4">Analyze</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function () {

        $('#analyzeModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var jobName = button.data('jobname');
            var jobDesc = button.data('jobdesc');
            $('#analyzeJobTitle').text('Analyzing: ' + jobName);
            $('#analyzeModal').data('jobdesc', jobDesc);
        });

        $('#analyzeModal button.btn-primary').on('click', function () {
            var jobName = $('#analyzeJobTitle').text().replace("Analyzing: ", "");
            var jobDesc = $('#analyzeModal').data('jobdesc');
            var fileInput = $('#analyzeModal input[type="file"]')[0];

            var formData = new FormData();
            formData.append('jobName', jobName);
            formData.append('jobDescription', jobDesc);

            if (fileInput.files.length > 0)
                formData.append('cvFile', fileInput.files[0]);

            $.ajax({
                url: '/Job/AnalyzeJob',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false
            })
            .done(function (data) {
                var rawScore = parseFloat(data.analysis);
                if (isNaN(rawScore)) rawScore = 0;

                var minRaw = 0.3, maxRaw = 0.8, minVisual = 70, maxVisual = 100;
                var percent = Math.round(((rawScore - minRaw) / (maxRaw - minRaw)) * (maxVisual - minVisual) + minVisual);
                percent = Math.min(Math.max(percent, 0), 100);

                var r = Math.round(255 * (1 - percent / 100) * 0.5);
                var g = Math.round(128 + 127 * (percent / 100));
                var color = `rgb(${r},${g},0)`;

                var bar = $('#similarityBar');
                bar.css('width', percent + '%');
                bar.css('background-color', color);
                bar.text(percent + '%');
            })
            .fail(function (xhr) {
                var errorText = xhr.responseJSON?.error || xhr.responseText || 'Unknown error';
                alert('Error: ' + errorText);
            });
        });
    });
</script>
}
