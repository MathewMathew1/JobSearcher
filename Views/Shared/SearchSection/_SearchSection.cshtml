@using JobSearcher.JobOpening
@model JobSearcher.ViewModels.SearchSectionViewModel

<div class="mb-4 shadow-sm p-4 rounded-4 bg-light border">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0 text-primary">@Model.Site Job Search</h5>
        <button class="btn btn-outline-primary btn-sm fw-semibold"
                data-bs-toggle="collapse"
                data-bs-target="#section-@Model.Site"
                aria-expanded="false"
                aria-controls="section-@Model.Site">
            Toggle
        </button>
    </div>

    <div class="collapse" id="section-@Model.Site">
        <ul class="list-group mb-4" id="list-@Model.Site">
            @foreach (var search in Model.Searches)
            {
                <li class="list-group-item bg-white border-0 shadow-sm rounded-3 mb-2 p-3">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <form asp-controller="UserJobSearcher"
                              asp-action="Update"
                              id="update-form-@Model.Site-@search.Id"
                              method="post"
                              class="ajax-update d-flex flex-wrap flex-grow-1 align-items-center gap-2">
                            <input type="hidden" name="site" value="@search.Site" />
                            <input type="hidden" name="id" value="@search.Id" />

                            <input type="text" class="form-control flex-grow-1" name="JobSearched" value="@search.JobSearched" placeholder="Job title" required />
                            <input type="text" class="form-control flex-grow-1" name="Location" value="@search.Location" placeholder="Location" required />

                            @if (Model.Site == Site.Indeed)
                            {
                                <input type="text" class="form-control flex-grow-1" name="CountryCode" value="@search.CountryCode" placeholder="Country code" required />
                            }

                            <button type="submit" class="btn btn-success btn-sm px-3 fw-semibold">Save</button>
                        </form>

                        <form asp-controller="UserJobSearcher"
                              asp-action="Delete"
                              id="delete-form-@Model.Site-@search.Id"
                              method="post"
                              class="ajax-delete mb-0">
                            <input type="hidden" name="id" value="@search.Id" />
                            <button type="submit" class="btn btn-danger btn-sm px-3 fw-semibold">Delete</button>
                        </form>
                    </div>
                </li>
            }

            <li class="no-searches list-group-item text-muted border-0 text-center @(Model.Searches.Count != 0 ? "d-none" : "")">
                No searches saved yet.
            </li>
        </ul>

        <form asp-controller="UserJobSearcher"
              asp-action="Create"
              method="post"
              id="formCreateSearch-@Model.Site"
              class="form-create-search @(Model.CanAddMore ? "" : "d-none")"
              data-site="@Model.Site">
            <input type="hidden" name="Site" value="@Model.Site" />

            <div class="row g-3 align-items-center mb-3">
                <div class="col-md">
                    <input type="text" class="form-control" name="JobSearched" placeholder="Job title" required />
                </div>
                <div class="col-md">
                    <input type="text" class="form-control" name="Location" placeholder="Location" required />
                </div>

                @if (Model.Site == Site.Indeed)
                {
                    <div class="col-md">
                        <input type="text" class="form-control" name="CountryCode"
                               placeholder="Country code (e.g. PL)" required />
                    </div>
                }

                <div class="col-md-auto text-end">
                    <button type="submit" class="btn btn-gradient px-4 fw-semibold">
                        Add Search
                    </button>
                </div>
            </div>
        </form>

        <div class="alert alert-warning text-center @(Model.CanAddMore ? "d-none" : "")">
            Maximum of 3 searches reached for @Model.Site.
        </div>
    </div>
</div>

<style>
.btn-gradient {
    background: linear-gradient(90deg, #0d6efd, #6610f2);
    color: #fff;
    border: none;
    transition: opacity 0.2s ease;
}
.btn-gradient:hover {
    opacity: 0.9;
    color: #fff;
}
.form-control {
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
    border-radius: 0.5rem;
}
.form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
}
h5 {
    letter-spacing: 0.3px;
}
.list-group-item {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.list-group-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
</style>



<script src="~/js/toast.js" asp-append-version="true"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>


<script type="application/javascript">
    $(function () {
        $(document).on('submit', "#formCreateSearch-@Model.Site", function (e) {
            e.preventDefault()

            let $form = $(this)
            let url = $form.attr("action")

            $.post(url, $form.serialize(), function (created) {
                let newLi = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${created.jobSearched} (${created.location})</span>
                    <form asp-controller="UserJobSearcher" asp-action="Delete"
                          id="delete-form-@Model.Site-${created.id}"
                          method="post" class="mb-0 ajax-delete">
                        <input type="hidden" name="id" value="${created.id}" />
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </li>
            `;
                $("#list-@Model.Site").append(newLi);

                $form[0].reset();
                $form.closest(".collapse").find(".no-searches").addClass("d-none");
                let count = $("#list-@Model.Site").children("li").length;

                if (count >= 3 + 1) {
                    $form.addClass("d-none");
                    $form.closest(".collapse").find(".alert.alert-warning").removeClass("d-none");
                }


            }).fail(function (xhr) {
                addToast({ message: 'Failed to create search', type: 'error' })
                console.log(xhr)
            });
        })
    })
    $(function () {
        $(document).on('submit', 'form[id^="delete-form-@Model.Site"]', function (e) {
            e.preventDefault()

            let $form = $(this)
            let url = $form.attr("action")

            $.post(url, $form.serialize(), function (deleted) {
                $form.closest("li").remove();

                let $list = $("#list-@Model.Site");

                $("#formCreateSearch-@Model.Site").removeClass("d-none");
                $list.closest(".collapse").find(".alert.alert-warning").addClass("d-none");

                if ($list.children("li").not(".no-searches").length === 0) {
                    let $noSearches = $list.find(".no-searches");
                    $noSearches.removeClass("d-none");
                }
                addToast({ message: 'Deleted search successfully', type: 'success' })
            }).fail(function (xhr) {
                addToast({ message: 'Failed to delete search', type: 'error' })
                console.log(xhr)
            });
        })
    })
    $(function () {
        $(document).on('submit', 'form[id^="update-form-@Model.Site"]', function (e) {
            e.preventDefault();

            let $form = $(this);
            let url = $form.attr("action");
            let data = $form.serialize();
            let id = $form.find("input[name='id']").val();

            $.ajax({
                url: url + "?id=" + id,
                type: "PATCH",
                data: data,
                success: function (updated) {

                    addToast({ message: 'Updated search successfully', type: 'success' })
                    $form.closest("li").addClass("bg-success-subtle");
                    setTimeout(() => $form.closest("li").removeClass("bg-success-subtle"), 1000);
                },
                error: function (xhr) {
                    addToast({ message: 'Failed to update search', type: 'error' })
                    console.log("Update failed:", xhr);
                }
            });
        });
    });

</script>