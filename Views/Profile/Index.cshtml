@using Microsoft.AspNetCore.Http
@model JobSearcher.Account.UserInDatabase

@{
    ViewData["Title"] = "Upload CV";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body p-4">

                    <h2 class="mb-4">Upload Your CV</h2>

                    <div id="uploadAlert" class="alert d-none" role="alert"></div>

                    <form id="cvUploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="cvFile" class="form-label fw-semibold">Select your CV (PDF or Word)</label>
                            <input class="form-control" type="file" id="cvFile" name="file" accept=".pdf,.doc,.docx"
                                required />
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                            <i class="bi bi-upload me-2"></i>Upload CV
                        </button>
                    </form>

                    <hr class="my-4">

                    <div>
                        <h4 class="mb-3">Current CV</h4>
                        <div id="currentCvList" class="list-group">

                            <div id="existing-cv"
                                class="list-group-item d-flex justify-content-between align-items-center @(Model?.UserCv != null ? "" : "d-none")">
                                <span>@Model?.UserCv?.Filename</span>
                                <div>
                                    <a href="@Url.Action("GetCv", "Profile")"
                                        class="btn btn-sm btn-outline-secondary me-2">
                                        <i class="bi bi-download"></i> Download
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="deleteCvBtn">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>



                            <div id="no-cv" class="list-group-item text-muted @(Model.UserCv == null ? "" : "d-none")">No CV
                                uploaded yet.</div>

                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(function () {
            // Upload or update CV
            $('#cvUploadForm').on('submit', function (e) {
                e.preventDefault();

                var fileInput = $('#cvFile')[0];
                if (fileInput.files.length === 0) return;

                var formData = new FormData();
                formData.append('file', fileInput.files[0]);

                var $btn = $('#uploadBtn');
                $btn.prop('disabled', true).text('Uploading...');

                $('#uploadAlert').removeClass('alert-success alert-danger').addClass('d-none').text('');

                var $cv = $('#existing-cv');
                if ($cv.hasClass('d-none')) {
                    method = 'POST';
                    url = '@Url.Action("UploadCv", "Profile")';
                } else {
                    method = 'PATCH';
                    url = '@Url.Action("UpdateCv", "Profile")';
                }

                $.ajax({
                    url: url,
                    method: method,
                    data: formData,
                    processData: false,
                    contentType: false
                })
                    .done(function (data) {
                        $('#uploadAlert').removeClass('d-none').addClass('alert-success').text('CV uploaded successfully.');

                       $cv.removeClass('d-none').find('span').text(data.filename);
                        var $noCv = $('#no-cv');
                        $noCv.addClass('d-none');
                        $('#currentCvList').html(html);
                    })
                    .fail(function (xhr) {
                        var error = xhr.responseText || 'Error uploading CV.';
                        $('#uploadAlert').removeClass('d-none').addClass('alert-danger').text(error);
                    })
                    .always(function () {
                        $btn.prop('disabled', false).text('Upload CV');
                        $('#cvFile').val('');
                    });
            });

            // Delete CV
            $(document).on('click', '#deleteCvBtn', function () {
                if (!confirm('Are you sure you want to delete your CV?')) return;

                $.ajax({
                    url: '@Url.Action("DeleteCv", "Profile")',
                    method: 'DELETE'
                })
                    .done(function () {
                        $('#uploadAlert').removeClass('d-none').addClass('alert-success').text('CV deleted successfully.');

                        // Replace with "No CV" message
                        $('#currentCvList').html('<div class="list-group-item text-muted">No CV uploaded yet.</div>');
                    })
                    .fail(function (xhr) {
                        var error = xhr.responseText || 'Error deleting CV.';
                        $('#uploadAlert').removeClass('d-none').addClass('alert-danger').text(error);
                    });
            });
        });
    </script>
}

}