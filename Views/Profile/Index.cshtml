@using Microsoft.AspNetCore.Http
@model JobSearcher.Account.UserInDatabase

@{
    ViewData["Title"] = "Upload CV";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body p-4">

                    <h2 class="mb-4">Upload Your CV</h2>

                    <div id="uploadAlert" class="alert d-none" role="alert"></div>

                    <form id="cvUploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="cvFile" class="form-label fw-semibold">Select your CV (PDF or Word)</label>
                            <input class="form-control" type="file" id="cvFile" name="file" accept=".pdf,.doc,.docx" required />
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                            <i class="bi bi-upload me-2"></i>Upload CV
                        </button>
                    </form>

                    <hr class="my-4">

                    <div>
                        <h4 class="mb-3">Current CV</h4>
                        <div id="currentCvList" class="list-group">
                            @if (Model.UserCv != null)
                            {
                                <div id="existing-cv" class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@Model.UserCv.Filename</span>
                                    <div>
                                        <a href="@Url.Action("GetCv","Profile")" class="btn btn-sm btn-outline-secondary me-2">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="deleteCvBtn">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="list-group-item text-muted">No CV uploaded yet.</div>
                            }
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(function () {
            $('#cvUploadForm').on('submit', function (e) {
                e.preventDefault();

                var fileInput = $('#cvFile')[0];
                if (fileInput.files.length === 0) return;

                var formData = new FormData();
                formData.append('file', fileInput.files[0]);

                var $btn = $('#uploadBtn');
                $btn.prop('disabled', true).text('Uploading...');

                $('#uploadAlert').removeClass('alert-success alert-danger').addClass('d-none').text('');

                var $cv = $('#existing-cv');
                console.log($cv.length)
                var method = $cv.length>0 ? 'PATCH': 'POST'
                var url = $cv.length>0 ? '@Url.Action("UpdateCv", "Profile")' : '@Url.Action("UploadCv", "Profile")'

                $.ajax({
                    url: url,
                    method: method,
                    data: formData,
                    processData: false,
                    contentType: false
                })
                    .done(function (data) {
                        $('#uploadAlert').removeClass('d-none').addClass('alert-success').text('CV uploaded successfully.');
                        if($cv.length>0){
                            $cv.html(fileInput.files[0].name);
                            addToast({ message: 'Uploaded cv successfully', type: 'success' })
                        }else{
                            $('#currentCvList').html('<div class="list-group-item">' + fileInput.files[0].name + '</div>');
                        }
                        $('#currentCvList').html('<div class="list-group-item">' + fileInput.files[0].name + '</div>');
                    })
                    .fail(function (xhr) {
                        var error = xhr.responseText || 'Error uploading CV.';
                        console.log(xhr);
                        $('#uploadAlert').removeClass('d-none').addClass('alert-danger').text(error);
                    })
                    .always(function () {
                        $btn.prop('disabled', false).text('Upload CV');
                        $('#cvFile').val('');
                    });
            });
        });
    </script>
}